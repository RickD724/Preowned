<!doctype html>
<html lang="en" data-theme="light">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Residual Pro ‚Äî By Ricardo</title>

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#0a0e1a">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

<style>
  :root{
    --bg: #050810;
    --bg-secondary: #0a0e1a;
    --card: rgba(255, 255, 255, 0.02);
    --card-hover: rgba(255, 255, 255, 0.05);
    --text: #1e293b;
    --text-primary: #0f172a;
    --muted: #64748b;
    --border: #e2e8f0;
    --border-hover: rgba(59, 130, 246, 0.4);
    --accent: #3b82f6;
    --accent-hover: #2563eb;
    --accent-glow: rgba(59, 130, 246, 0.2);
    --success: #10b981;
    --success-glow: rgba(16, 185, 129, 0.2);
    --danger: #ef4444;
    --warning: #f59e0b;
    --purple: #8b5cf6;
    --purple-glow: rgba(139, 92, 246, 0.2);
    --radius: 16px;
    --radius-sm: 10px;
    --shadow: 0 10px 40px rgba(15,23,42,0.1);
    --shadow-lg: 0 20px 60px rgba(15,23,42,0.15);
    --glow: 0 0 40px rgba(59, 130, 246, 0.15);
    --transition: all .25s ease;
  }
  html, body{
    background: #f5f7fa;
    color: var(--text);
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    font-size: 16px;
    line-height: 1.6;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    min-height: 100vh;
    overflow-x: hidden;
  }
  .wrap{ max-width: 980px; margin: 0 auto; padding: 20px 20px 100px; }
  .top{
    position: sticky; top: 0; z-index: 5;
    background: rgba(255,255,255,.9);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 12px 16px; margin-bottom: 16px; box-shadow: var(--shadow);
  }
  .brand{ display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
  .leftRow{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  .pill{
    display:inline-flex; align-items:center; gap:10px;
    background: linear-gradient(135deg, var(--accent) 0%, var(--purple) 100%);
    color:#fff; padding:10px 18px; border-radius:999px; font-weight:900; font-size:.95rem;
    box-shadow:0 8px 30px var(--accent-glow);
  }
  .theme,.btn{
    border:1px solid var(--border); background:#fff;
    color:var(--text); padding:9px 16px; border-radius:12px; cursor:pointer;
    font-weight:600; font-size:.9rem; transition:var(--transition);
  }
  .btn:hover{ background:#f8fafc; border-color:var(--border-hover); transform:translateY(-1px); }
  .select{ min-width:200px; }
  .card{
    background:#fff; border:1px solid var(--border); border-radius: var(--radius);
    box-shadow: var(--shadow); padding:22px; transition: var(--transition);
  }
  .grid{ display:grid; gap:14px; }
  .g4{ grid-template-columns:repeat(4,minmax(0,1fr)); }
  .g3{ grid-template-columns:repeat(3,minmax(0,1fr)); }
  .g2{ grid-template-columns:repeat(2,minmax(0,1fr)); }
  @media (max-width:900px){ .g4,.g3,.g2{ grid-template-columns:1fr; } }
  label{ font-size:.75rem; color:var(--muted); display:block; margin:0 0 6px; font-weight:700; text-transform:uppercase; letter-spacing:.8px; }
  select,input[type="number"],input[type="text"]{
    width:100%; background:#fff; color:var(--text);
    border:2px solid var(--border); border-radius:12px; padding:12px 14px; font-size:.95rem; font-weight:500;
  }
  .rowline{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
  .srow{
    display:flex; gap:12px; align-items:center; justify-content:space-between;
    background:linear-gradient(135deg, rgba(59,130,246,0.06), rgba(139,92,246,0.06));
    border:1px solid var(--border); border-radius:12px; padding:12px 14px;
  }
  .slabel{ font-weight:700; color:var(--muted); font-size:.9rem; }
  .sval{ font-variant-numeric:tabular-nums; font-weight:800; font-size:1.05rem; color:var(--text-primary); }
  .result{ display:flex; align-items:baseline; gap:16px; margin:16px 0; flex-wrap:wrap; padding:18px; border-radius:12px; border:1px solid var(--border); background:#fff; }
  .result .big{ font-size:3rem; font-weight:900; letter-spacing:-1px; color:var(--accent); }
  .badge{ display:inline-block; border:1px solid var(--border-hover); padding:6px 10px; border-radius:999px; font-size:.85rem; font-weight:800; background:#f8fafc; }
  .muted{ color:var(--muted); }
  .good{ color: var(--success); font-weight:800; }
  .bad{ color: var(--danger); font-weight:800; }
  /* Sniffer */
  #snifferCard .hit{ border:2px solid var(--accent); box-shadow:0 6px 24px var(--glow); }
  .sniffItem{
    border:1px solid var(--border); border-radius:16px; padding:14px; background:#fff; box-shadow:var(--shadow);
    margin-bottom:12px; cursor:pointer; transition: var(--transition);
  }
  .sniffItem:hover{ transform:translateY(-1px); border-color:var(--border-hover); }
  .sniffHead{ display:flex; align-items:center; justify-content:space-between; margin-bottom:6px; }
  .chip{ font-weight:800; border:1px solid var(--border); padding:6px 10px; border-radius:999px; background:#f8fafc; }
  .sniffLine{ display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; }
  .delta{ font-weight:900; }
  @media (max-width:375px){
    .sniffStack{ display:flex; flex-direction:column; gap:6px; width:100%; }
    .sniffStack .left{ width:100%; }
    .sniffStack .right{ width:100%; text-align:left; }
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="leftRow">
          <div class="pill">‚ö° Residual Pro ‚Äî By Ricardo</div>
          <select id="programSel" class="select">
            <option value="porsche_residuals_all.json">Program: PB 25-10R (Default)</option>
            <option value="porsche_residuals_25-09R.json">Program: PB 25-09R (Oct)</option>
            <option value="__current__">Program: Current (?data)</option>
          </select>
        </div>
        <div class="leftRow">
          <button id="validateBtn" class="btn" type="button">‚úì Validate</button>
          <button id="exportCsvBtn" class="btn" type="button">üì• Export</button>
          <button id="printBtn" class="btn" type="button">üñ®Ô∏è Print</button>
        </div>
      </div>
    </div>

    <div class="card" id="controls">
      <div class="grid g4">
        <div>
          <label>üöó Model Family</label>
          <select id="familySel"></select>
        </div>
        <div>
          <label>üìÖ Model Year</label>
          <select id="yearSel"></select>
        </div>
        <div>
          <label>üéØ Trim</label>
          <select id="trimSel"></select>
          <div class="muted" id="trimCount" style="font-size:.85rem;"></div>
        </div>
        <div>
          <label>üîç Search Trim</label>
          <input id="trimSearch" type="text" placeholder="Type to filter..." />
        </div>
      </div>

      <div class="grid g3" style="margin-top: 10px">
        <div>
          <label>‚è±Ô∏è Term (months)</label>
          <select id="termSel"></select>
        </div>
        <div>
          <label>üìä Miles per Year</label>
          <select id="annualMilesSel"></select>
        </div>
        <div class="rowline" style="margin-top: 28px">
          <label class="rowline" style="gap: 8px;">
            <input id="pacpoToggle" type="checkbox" />
            <span>+2% PACPO</span>
          </label>
          <label class="rowline" style="gap: 8px;">
            <input id="hideNA" type="checkbox" />
            <span>Hide N/A</span>
          </label>
          <div class="badge" id="codeBadge">Code: ‚Äî</div>
        </div>
      </div>

      <div class="grid g3" style="margin-top: 10px">
        <div>
          <label>üõ£Ô∏è Miles at Inception</label>
          <input id="odoInput" type="number" min="0" step="1" placeholder="e.g., 3,450" />
        </div>
        <div>
          <label>üí∞ MSRP ($)</label>
          <input id="msrpInput" type="number" min="0" step="100" placeholder="e.g., 142,000" />
        </div>
        <div>
          <label>üîó Shareable Link</label>
          <input id="shareLink" type="text" readonly style="font-size:0.85rem;" />
        </div>
      </div>
    </div>

    <div class="card" style="margin-top: 14px;">
      <div class="result">
        <div class="big" id="finalOut">‚Äî</div>
        <div class="muted" id="detailOut">Select options to calculate</div>
        <div id="trueOut" style="font-weight:800;"></div>
        <div class="badge" id="lviBadge"></div>
      </div>
    </div>

    <div class="card" id="leaseCard" style="margin-top: 14px;">
      <div class="rowline" style="justify-content:space-between; margin-bottom:8px;">
        <strong style="font-size:1.1rem;">üí≥ Lease Estimator</strong>
        <span class="muted" style="font-size:0.95rem;">Uses current RV% & term</span>
      </div>

      <div class="grid g3">
        <div>
          <label>üíµ Cap Cost ($)</label>
          <input id="leaseCapCost" type="number" min="0" step="100" />
          <div class="muted" style="font-size:.85rem;">Selling price before down</div>
        </div>
        <div>
          <label>üìà Money Factor</label>
          <input id="leaseMF" type="number" min="0" step="0.00001" />
          <div class="muted" id="mfAprHint" style="font-size:.85rem;"></div>
        </div>
        <div>
          <label>üßæ Tax Rate (%)</label>
          <input id="leaseTax" type="number" min="0" step="0.01" />
        </div>
      </div>

      <div class="grid g3" style="margin-top:10px">
        <div>
          <label>üí∏ Cap Reduction ($)</label>
          <input id="leaseCapReduction" type="number" min="0" step="100" />
        </div>
        <div>
          <label>üìù Rolled Fees ($)</label>
          <input id="leaseFees" type="number" min="0" step="25" />
        </div>
        <div>
          <label>‚è∞ Term (mo)</label>
          <input id="leaseTerm" type="number" min="12" step="1" placeholder="auto" />
          <div class="muted" style="font-size:.85rem;">Auto-fills then you can override</div>
        </div>
      </div>

      <div class="grid g2" style="margin-top:10px">
        <div class="srow"><span class="slabel">Residual %</span><span class="sval" id="leaseRvPct">‚Äî</span></div>
        <div class="srow"><span class="slabel">Residual $</span><span class="sval" id="leaseRvAmt">‚Äî</span></div>
      </div>

      <div class="grid sniffStack" style="margin-top:10px">
        <div class="srow left" style="border:2px solid var(--success);"><span class="slabel" style="color:var(--success);">Monthly (Pre-Tax)</span><span class="sval" id="leasePreTax" style="color:var(--success);font-size:1.2rem;">‚Äî</span></div>
        <div class="srow right" style="border:2px solid var(--purple);"><span class="slabel" style="color:var(--purple);">Monthly (With Tax)</span><span class="sval" id="leaseWithTax" style="color:var(--purple);font-size:1.2rem;">‚Äî</span></div>
      </div>
    </div>

    <div class="card" id="snifferCard" style="margin-top:14px;">
      <div class="rowline" style="justify-content:space-between; margin-bottom:8px;">
        <strong style="font-size:1.1rem;">üîé Lease Sniffer (Optimizes by LVI ‚Üí Payment)</strong>
        <span class="muted">Tests other terms using the same structure</span>
      </div>
      <div id="snifferList"></div>
    </div>

    <div class="card" style="margin-top:14px;">
      <div class="rowline" style="justify-content:center;">
        <span class="muted">¬© Ricardo ‚Äî Internal tool</span>
      </div>
    </div>
  </div>

<script>
(function(){
  /* ---------- helpers ---------- */
  function normalizeYearKey(k){
    var s = String(k).trim();
    var mPlain = s.match(/^(20\\d{2})$/); if (mPlain) return { display: 'MY' + mPlain[1].slice(-2), key: k };
    var mMY = s.toUpperCase().replace(/\\s+/g,'').match(/^MY(\\d{2})$/); if (mMY) return { display: 'MY' + mMY[1], key: k };
    return { display: s, key: k };
  }
  function getCaseInsensitive(obj, name){
    if(!obj || typeof obj !== "object") return undefined;
    var target = String(name).replace(/\\s+/g,'').toLowerCase();
    var keys = Object.keys(obj);
    for(var i=0;i<keys.length;i++){ if(keys[i].replace(/\\s+/g,'').toLowerCase() === target) return obj[keys[i]]; }
    return undefined;
  }
  function parseRange(str){
    if(!str) return null;
    var s = str.replace(/,/g,'').replace(/\\s/g,'');
    var parts = s.split(/‚Äì|-/); if(parts.length !== 2) return null;
    var a = parseInt(parts[0],10), b = parseInt(parts[1],10);
    if(isNaN(a) || isNaN(b)) return null;
    return [a,b];
  }
  function findInceptionAdj(data, myKey, dispYear, odo){
    var bands = (data && data.mileage_at_inception_adjustments_percent && (data.mileage_at_inception_adjustments_percent[myKey] || data.mileage_at_inception_adjustments_percent[dispYear] || data.mileage_at_inception_adjustments_percent[dispYear.replace(/\\s+/g,'')])) || null;
    if(!bands || odo == null) return 0;
    for(var i=0;i<bands.length;i++){
      var rng = parseRange(bands[i].miles_range); if(!rng) continue;
      if(odo >= rng[0] && odo <= rng[1]) return bands[i].adj || 0;
    }
    return 0;
  }
  function computeLVI(rvPercent, mf){ if(!isFinite(rvPercent) || !isFinite(mf) || mf <= 0) return null; return rvPercent / mf; }
  function money(n){ return '$' + Math.round(n).toLocaleString(); }

  /* ---------- elements ---------- */
  var programSel = document.getElementById('programSel');
  var familySel = document.getElementById('familySel');
  var yearSel = document.getElementById('yearSel');
  var trimSel = document.getElementById('trimSel');
  var trimSearch = document.getElementById('trimSearch');
  var trimCount = document.getElementById('trimCount');
  var termSel = document.getElementById('termSel');
  var annualMilesSel = document.getElementById('annualMilesSel');
  var pacpoToggle = document.getElementById('pacpoToggle');
  var hideNA = document.getElementById('hideNA');
  var odoInput = document.getElementById('odoInput');
  var msrpInput = document.getElementById('msrpInput');
  var codeBadge = document.getElementById('codeBadge');
  var finalOut = document.getElementById('finalOut');
  var detailOut = document.getElementById('detailOut');
  var trueOut = document.getElementById('trueOut');
  var lviBadge = document.getElementById('lviBadge');

  var leaseCapCost = document.getElementById('leaseCapCost');
  var leaseMF = document.getElementById('leaseMF');
  var leaseTax = document.getElementById('leaseTax');
  var leaseCapReduction = document.getElementById('leaseCapReduction');
  var leaseFees = document.getElementById('leaseFees');
  var leaseTerm = document.getElementById('leaseTerm');
  var leaseRvPct = document.getElementById('leaseRvPct');
  var leaseRvAmt = document.getElementById('leaseRvAmt');
  var leasePreTax = document.getElementById('leasePreTax');
  var leaseWithTax = document.getElementById('leaseWithTax');
  var mfAprHint = document.getElementById('mfAprHint');

  var snifferList = document.getElementById('snifferList');

  var exportCsvBtn = document.getElementById('exportCsvBtn');
  var printBtn = document.getElementById('printBtn');
  var validateBtn = document.getElementById('validateBtn');

  var data=null, MONTHS=[], PACPO=2, fullTrimList=[];
  var estimatorTermLocked=false;

  /* ---------- defaults for estimator (pre-filled & editable) ---------- */
  function applyEstimatorDefaultsIfEmpty(){
    if(!leaseMF.value) leaseMF.value = '0.00400';
    if(!leaseTax.value) leaseTax.value = '9.75';
    if(!leaseCapReduction.value) leaseCapReduction.value = '7500';
    if(!leaseFees.value) leaseFees.value = '1095';
  }

  /* ---------- program loading ---------- */
  var initialProgram = 'porsche_residuals_all.json';
  function loadProgram(file){
    var target = (file === '__current__') ? (new URLSearchParams(location.search).get('data') || initialProgram) : file;
    return fetch(target + '?t=' + Date.now(), {cache:'no-store'}).then(function(r){
      if(!r.ok) throw new Error('HTTP '+r.status);
      return r.json();
    }).then(function(j){
      data = j; window.__data = j;
      MONTHS = data.months || ["12","18","24","27","30","36","39","42","48","51","60"];
      PACPO = data.pacpo_bonus_percent || 2;
      initSelectors();
      compute();
    }).catch(function(e){ alert('Failed to load program: '+e.message); });
  }

  function getVirtualFamilies(){
    var out = new Set();
    var models = data.models || {};
    Object.keys(models).forEach(function(f){
      if(f === '718'){
        var cay = getCaseInsensitive(models['718'],'Cayman');
        var box = getCaseInsensitive(models['718'],'Boxster');
        if (cay) out.add('718 Cayman'); if (box) out.add('718 Boxster');
      } else { out.add(f); }
    });
    if(models['Cayman']) out.add('718 Cayman');
    if(models['Boxster']) out.add('718 Boxster');
    var order = ['911','718 Cayman','718 Boxster','Taycan','Macan','Cayenne','Panamera'];
    return Array.from(out).sort(function(a,b){ return order.indexOf(a) - order.indexOf(b); });
  }
  function branchForFamily(famDisp){
    var models = data.models || {};
    if (famDisp === '718 Cayman') return getCaseInsensitive(models['718']||{}, 'Cayman') || models['Cayman'] || {};
    if (famDisp === '718 Boxster') return getCaseInsensitive(models['718']||{}, 'Boxster') || models['Boxster'] || {};
    return models[famDisp] || {};
  }
  function yearsForFamily(famDisp){
    var out = new Set(); var branch = branchForFamily(famDisp);
    Object.keys(branch).forEach(function(k){ out.add(normalizeYearKey(k).display); });
    return Array.from(out).sort(function(a,b){
      var ay = parseInt(a.replace(/\\D/g,''),10), by = parseInt(b.replace(/\\D/g,''),10);
      if (isNaN(ay) || isNaN(by)) return b.localeCompare(a);
      return by - ay;
    });
  }
  function populate(select, arr){
    select.innerHTML = '';
    arr.forEach(function(v){ var opt = document.createElement('option'); opt.value = v; opt.textContent = v; select.appendChild(opt); });
  }
  function collectTrimsForYear(){
    fullTrimList = [];
    var branch = branchForFamily(familySel.value);
    var dispYear = yearSel.value;
    var yearKey = Object.keys(branch).find(function(k){ return normalizeYearKey(k).display === dispYear; });
    var rows = (yearKey && branch[yearKey]) || {};
    Object.entries(rows).forEach(function(entry){ fullTrimList.push({code: entry[0], model: entry[1].model || entry[0]}); });
  }
  function populateTrims(filterTerm){
    trimSel.innerHTML='';
    var t=(filterTerm||'').trim().toLowerCase();
    var filtered = fullTrimList.filter(function(x){ return (x.model+' '+x.code).toLowerCase().indexOf(t)!==-1; });
    filtered.forEach(function(item){ var opt=document.createElement('option'); opt.value=item.code; opt.textContent=item.model; opt.dataset.code=item.code; trimSel.appendChild(opt); });
    trimCount.textContent = filtered.length ? (filtered.length + ' trim(s) available') : 'No matches';
  }
  function populateAnnualMiles(){
    annualMilesSel.innerHTML='';
    var milesMap = (data && data.annual_mileage_adjustments_percent && data.annual_mileage_adjustments_percent.miles_per_year) || {
      "2500":6,"5000":5,"7500":4,"10000":3,"12000":2,"15000":0
    };
    Object.keys(milesMap).map(function(k){return parseInt(k,10);}).sort(function(a,b){return a-b;})
      .forEach(function(n){ var opt=document.createElement('option'); opt.value=String(n); opt.textContent=n.toLocaleString()+' mi/yr'; annualMilesSel.appendChild(opt); });
    annualMilesSel.value="15000";
  }
  function initSelectors(){
    populate(familySel, getVirtualFamilies());
    populate(yearSel, yearsForFamily(familySel.value));
    termSel.innerHTML=''; MONTHS.forEach(function(m){ var o=document.createElement('option'); o.value=m; o.textContent=m+' months'; termSel.appendChild(o); });
    populateAnnualMiles();
    collectTrimsForYear(); populateTrims('');
    applyEstimatorDefaultsIfEmpty();
  }

  /* ---------- main compute & estimator ---------- */
  function compute(){
    var fam = familySel.value;
    var branch = branchForFamily(fam);
    var dispYear = yearSel.value;
    var yrKey = Object.keys(branch).find(function(k){ return normalizeYearKey(k).display === dispYear; });
    var code = trimSel.value;
    var term = termSel.value;
    var milesPerYear = parseInt(annualMilesSel.value,10);
    var odo = odoInput.value ? parseInt(String(odoInput.value).replace(/,/g,''),10) : null;

    if(!yrKey || !code){
      finalOut.textContent='‚Äî'; detailOut.textContent='Select family/year/trim'; trueOut.textContent=''; lviBadge.textContent='';
      return;
    }
    var entry = branch[yrKey][code];
    codeBadge.textContent = 'Code: ' + (code || '‚Äî');

    var base = term ? ((entry && entry.residuals && entry.residuals[term]) || null) : null;
    var pacpoAdj = pacpoToggle.checked ? (data.pacpo_bonus_percent || 2) : 0;
    var milesMap = (data && data.annual_mileage_adjustments_percent && data.annual_mileage_adjustments_percent.miles_per_year) || {};
    var annualAdj = 0;
    if(base !== null && parseInt(term||'0',10) >= 24){ annualAdj = milesMap[String(milesPerYear)] || 0; }
    var inceptionAdj = findInceptionAdj(data, yrKey, dispYear, odo);

    var final = (base === null || term == null) ? null : (base + pacpoAdj + annualAdj + inceptionAdj);
    finalOut.textContent = final===null ? '‚Äî' : final.toFixed(2) + '%';
    detailOut.textContent = final===null ? 'Select a term' : 'Final with all adjustments';

    // live MSRP √ó RV%
    var msrp = msrpInput.value ? Number(msrpInput.value) : NaN;
    var trueResidual = (final != null && isFinite(msrp)) ? Math.round(msrp*(final/100)) : null;
    trueOut.textContent = (trueResidual!=null) ? ('MSRP √ó RV% = $'+ trueResidual.toLocaleString()) : '';

    // LVI vs MF input
    var mfVal = leaseMF && leaseMF.value ? Number(leaseMF.value) : NaN;
    var lvi = computeLVI(final, mfVal);
    lviBadge.textContent = (lvi!=null) ? ('LVI: ' + (lvi/1000).toFixed(1) + 'k') : '';

    // lease estimator ‚Äî only auto-fill leaseTerm if user hasn't edited it
    if(!estimatorTermLocked && termSel && termSel.value) leaseTerm.value = termSel.value;
    leaseEstimatorCompute(final);

    // run sniffer
    runSniffer(entry, yrKey, dispYear, pacpoAdj, milesMap, milesPerYear, odo, mfVal);
  }

  function leaseEstimatorCompute(finalPercent){
    var rvPct = (isFinite(finalPercent) ? finalPercent : NaN);
    var msrp = msrpInput.value ? Number(msrpInput.value) : NaN;
    var term = leaseTerm.value ? parseInt(leaseTerm.value,10) : NaN;
    var cap = leaseCapCost.value ? Number(leaseCapCost.value) : NaN;
    var mf = leaseMF.value ? Number(leaseMF.value) : NaN;
    var tax = leaseTax.value ? Number(leaseTax.value)/100 : 0;
    var capRed = leaseCapReduction.value ? Number(leaseCapReduction.value) : 0;
    var fees = leaseFees.value ? Number(leaseFees.value) : 0;

    leaseRvPct.textContent = isFinite(rvPct) ? (rvPct.toFixed(2)+'%') : '‚Äî';
    if(!isFinite(msrp) || !isFinite(rvPct) || !isFinite(term) || term<=0){
      leaseRvAmt.textContent='‚Äî'; leasePreTax.textContent='‚Äî'; leaseWithTax.textContent='‚Äî'; mfAprHint.textContent = isFinite(mf) ? ('‚âà ' + (mf*2400).toFixed(2) + '% APR') : '';
      return;
    }
    var rvAmt = Math.round(msrp * (rvPct/100));
    leaseRvAmt.textContent = '$' + rvAmt.toLocaleString();
    var adjCap = (isFinite(cap)?cap:0) - (isFinite(capRed)?capRed:0) + (isFinite(fees)?fees:0);
    if(!isFinite(adjCap) || adjCap<=0 || !isFinite(mf) || mf<=0){
      leasePreTax.textContent='‚Äî'; leaseWithTax.textContent='‚Äî'; mfAprHint.textContent = isFinite(mf) ? ('‚âà ' + (mf*2400).toFixed(2) + '% APR') : '';
      return;
    }
    var dep = (adjCap - rvAmt) / term;
    var fin = (adjCap + rvAmt) * mf;
    var preTax = dep + fin;
    var withTax = preTax * (1 + (isFinite(tax)?tax:0));
    leasePreTax.textContent = money(preTax);
    leaseWithTax.textContent = money(withTax);
    mfAprHint.textContent = isFinite(mf) ? ('‚âà ' + (mf*2400).toFixed(2) + '% APR') : '';
  }

  function computePaymentForTerm(finalPercent, term){
    var msrp = msrpInput.value ? Number(msrpInput.value) : NaN;
    var cap = leaseCapCost.value ? Number(leaseCapCost.value) : NaN;
    var mf = leaseMF.value ? Number(leaseMF.value) : NaN;
    var tax = leaseTax.value ? Number(leaseTax.value)/100 : 0;
    var capRed = leaseCapReduction.value ? Number(leaseCapReduction.value) : 0;
    var fees = leaseFees.value ? Number(leaseFees.value) : 0;
    if(!isFinite(finalPercent) || !isFinite(msrp) || !isFinite(term) || !isFinite(cap) || !isFinite(mf)) return {pre:null, with:null};
    var rvAmt = Math.round(msrp * (finalPercent/100));
    var adjCap = cap - (isFinite(capRed)?capRed:0) + (isFinite(fees)?fees:0);
    var dep = (adjCap - rvAmt) / term;
    var fin = (adjCap + rvAmt) * mf;
    var preTax = dep + fin;
    var withTax = preTax * (1 + (isFinite(tax)?tax:0));
    return {pre:preTax, with:withTax};
  }

  function runSniffer(entry, yrKey, dispYear, pacpoAdj, milesMap, milesPerYear, odo, mfVal){
    // build list for all terms (visible by Hide N/A)
    var terms = (function(){
      if(!hideNA.checked) return MONTHS.slice();
      var r=[]; for(var i=0;i<MONTHS.length;i++){ if(entry && entry.residuals && entry.residuals[MONTHS[i]] != null) r.push(MONTHS[i]); }
      return r;
    })();

    // baseline (current term)
    var curTerm = termSel.value ? parseInt(termSel.value,10) : NaN;
    var base = entry && entry.residuals && entry.residuals[String(curTerm)];
    var baseAnnual = (!isNaN(curTerm) && curTerm>=24) ? (milesMap[String(parseInt(annualMilesSel.value,10))] || 0) : 0;
    var baseIncep = findInceptionAdj(data, yrKey, dispYear, odo);
    var baseFinal = (base!=null) ? (base + pacpoAdj + baseAnnual + baseIncep) : null;
    var basePay = computePaymentForTerm(baseFinal, curTerm).with;

    var rows=[];
    for(var i=0;i<terms.length;i++){
      var t = parseInt(terms[i],10);
      var v = entry && entry.residuals && entry.residuals[String(t)];
      if(v==null) continue;
      var aAdj = (t>=24) ? (milesMap[String(milesPerYear)] || 0) : 0;
      var finalPercent = v + pacpoAdj + aAdj + baseIncep; // same inception adj for same MY
      var pay = computePaymentForTerm(finalPercent, t);
      var lvi = computeLVI(finalPercent, mfVal);
      rows.push({
        term:t,
        rv: finalPercent,
        pre: pay.pre,
        with: pay.with,
        lvi: lvi
      });
    }

    // rank by LVI desc, then payment asc
    rows = rows.filter(function(x){ return isFinite(x.lvi) && isFinite(x.with); });
    rows.sort(function(a,b){
      if(b.lvi !== a.lvi) return b.lvi - a.lvi;
      return a.with - b.with;
    });
    var top = rows.slice(0,5);

    // render
    snifferList.innerHTML='';
    top.forEach(function(r,idx){
      var card=document.createElement('div');
      card.className='sniffItem'+(idx===0?' hit':'');

      var head=document.createElement('div'); head.className='sniffHead';
      head.innerHTML='<div class="chip">Term: '+r.term+' mo</div><div class="chip">LVI: '+(r.lvi/1000).toFixed(1)+'k</div>';
      card.appendChild(head);

      var line1=document.createElement('div'); line1.className='sniffLine';
      line1.innerHTML='<div><strong>Final RV% </strong>'+r.rv.toFixed(2)+'%  &nbsp; <span class="muted">Pre-Tax</span> <strong>'+money(r.pre)+'</strong></div><div class="muted"> </div>';
      card.appendChild(line1);

      var line2=document.createElement('div'); line2.className='sniffLine';
      var deltaSpan = document.createElement('span'); deltaSpan.className='delta';
      var deltaTxt='‚Äî';
      if(isFinite(basePay) && isFinite(r.with)){
        var d = Math.round(r.with - basePay);
        if(d<0){ deltaTxt = 'Œî$/mo save ' + money(-d); deltaSpan.classList.add('good'); }
        else if(d>0){ deltaTxt = 'Œî$/mo add ' + money(d); deltaSpan.classList.add('bad'); }
        else { deltaTxt = 'Œî$/mo $0'; }
      }
      deltaSpan.textContent = deltaTxt;
      line2.appendChild((function(){
        var span=document.createElement('span');
        span.innerHTML='<span class="muted">With-Tax</span> <strong>'+money(r.with)+'</strong> &nbsp; <span class="muted">ŒîLVI</span> '+(isFinite(rows[0].lvi)&&isFinite(r.lvi)?('+'+((r.lvi - (computeLVI(baseFinal, leaseMF.value?Number(leaseMF.value):NaN)||0))/1000).toFixed(1)+'k'):'‚Äî');
        return span;
      })());
      line2.appendChild(deltaSpan);
      card.appendChild(line2);

      var foot=document.createElement('div'); foot.className='muted'; foot.style.marginTop='6px'; foot.textContent='Tap to apply';
      card.appendChild(foot);

      card.addEventListener('click', function(){
        termSel.value = String(r.term);
        leaseTerm.value = String(r.term); // also push into estimator
        estimatorTermLocked = true;       // preserve manual override thereafter
        compute(); // recompute everything with new term
        window.scrollTo({top: document.getElementById('leaseCard').offsetTop - 8, behavior:'smooth'});
      });

      snifferList.appendChild(card);
    });
  }

  /* ---------- events ---------- */
  programSel.addEventListener('change', function(){ loadProgram(programSel.value); });
  familySel.addEventListener('change', function(){ populate(yearSel, yearsForFamily(familySel.value)); collectTrimsForYear(); populateTrims(trimSearch.value); compute(); });
  yearSel.addEventListener('change', function(){ collectTrimsForYear(); populateTrims(trimSearch.value); compute(); });
  trimSearch.addEventListener('input', function(){ populateTrims(trimSearch.value); compute(); });
  trimSel.addEventListener('change', compute);
  termSel.addEventListener('change', function(){ if(!estimatorTermLocked) leaseTerm.value = termSel.value; compute(); });
  annualMilesSel.addEventListener('change', compute);
  pacpoToggle.addEventListener('change', compute);
  hideNA.addEventListener('change', compute);
  odoInput.addEventListener('input', compute);
  msrpInput.addEventListener('input', compute);

  leaseCapCost.addEventListener('input', compute);
  leaseMF.addEventListener('input', compute);
  leaseTax.addEventListener('input', compute);
  leaseCapReduction.addEventListener('input', compute);
  leaseFees.addEventListener('input', compute);
  leaseTerm.addEventListener('input', function(){ estimatorTermLocked = true; compute(); });

  exportCsvBtn.addEventListener('click', function(){ window.alert('CSV export unchanged in this build.'); });
  printBtn.addEventListener('click', function(){ window.print(); });
  validateBtn.addEventListener('click', function(){ window.alert('Validator placeholder ‚Äî same logic as previous build.'); });

  // boot
  loadProgram(programSel.value);
  applyEstimatorDefaultsIfEmpty();
})();
</script>

</body>
</html>
